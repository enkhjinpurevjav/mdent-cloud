{
  # Change to a real email for Let's Encrypt
  email youremail@domain.com
}

# Main web app for staff and managers
mdent.cloud, www.mdent.cloud, app.mdent.cloud {
  encode gzip

  # Media files (X‑rays, photos, documents) → backend
  handle_path /media/* {
    reverse_proxy mdent-cloud-backend-1:8080
  }

  # Everything else → frontend (Next.js)
  handle {
    reverse_proxy frontend:3000
  }
}

# Booking / doctor UI (if using a separate "book" app)
book.mdent.cloud {
  encode gzip
  reverse_proxy frontend:3000
}

# Public API domain
api.mdent.cloud {
  encode gzip

  # CORS preflight for /api/* (OPTIONS)
  @cors_preflight {
    method OPTIONS
    path /api/*
  }

  handle @cors_preflight {
    header {
      Access-Control-Allow-Origin https://mdent.cloud
      Access-Control-Allow-Methods GET,POST,PUT,PATCH,DELETE,OPTIONS
      Access-Control-Allow-Headers Authorization,Content-Type
      Access-Control-Allow-Credentials true
      Access-Control-Max-Age 86400
    }
    respond "" 204
  }

  # All other requests → backend API
  handle {
    reverse_proxy mdent-cloud-backend-1:8080

    # CORS headers for normal API responses
    header {
      Access-Control-Allow-Origin https://mdent.cloud
      Access-Control-Allow-Methods GET,POST,PUT,PATCH,DELETE,OPTIONS
      Access-Control-Allow-Headers Authorization,Content-Type
      Access-Control-Allow-Credentials true
      Access-Control-Max-Age 86400
    }
  }
}
