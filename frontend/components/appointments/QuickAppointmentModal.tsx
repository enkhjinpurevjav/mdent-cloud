import React, { useState, useEffect } from "react";
import type { Branch, Doctor, ScheduledDoctor, Appointment, PatientLite, DoctorScheduleDay } from "./types";
import { formatDoctorName, formatPatientSearchLabel } from "./formatters";
import { SLOT_MINUTES, addMinutesToTimeString, generateTimeSlotsForDay, getSlotTimeString, isTimeWithinRange } from "./time";

type QuickAppointmentModalProps = {
  open: boolean;
  onClose: () => void;
  defaultDoctorId?: number;
  defaultDate: string; // YYYY-MM-DD
  defaultTime: string; // HH:MM
  branches: Branch[];
  doctors: Doctor[];
  scheduledDoctors: ScheduledDoctor[];
  appointments: Appointment[];
  selectedBranchId: string;
  onCreated: (a: Appointment) => void;

  editingAppointment?: Appointment | null;
  onUpdated?: (a: Appointment) => void;
};

export default function QuickAppointmentModal({
  open,
  onClose,
  defaultDoctorId,
  defaultDate,
  defaultTime,
  branches,
  doctors,
  scheduledDoctors,
  appointments,
  selectedBranchId,
  onCreated,
  editingAppointment,
  onUpdated,
}: QuickAppointmentModalProps) {
  const isEditMode = Boolean(editingAppointment);

  const [form, setForm] = useState({
    patientQuery: "",
    patientId: null as number | null,

    doctorId: defaultDoctorId ? String(defaultDoctorId) : "",
    branchId: selectedBranchId || (branches.length ? String(branches[0].id) : ""),

    date: defaultDate,
    startTime: defaultTime,
    endTime: addMinutesToTimeString(defaultTime, SLOT_MINUTES),

    status: "booked",
    notes: "",
  });

  const [error, setError] = useState("");

  const workingDoctors = scheduledDoctors.length ? scheduledDoctors : doctors;

  const [patientResults, setPatientResults] = useState<PatientLite[]>([]);
  const [patientSearchLoading, setPatientSearchLoading] = useState(false);
  const [searchDebounceTimer, setSearchDebounceTimer] =
    useState<NodeJS.Timeout | null>(null);

  // time slot options
  const [popupStartSlots, setPopupStartSlots] = useState<
    { label: string; value: string }[]
  >([]);
  const [popupEndSlots, setPopupEndSlots] = useState<
    { label: string; value: string }[]
  >([]);

  // quick new patient (create mode only)
  const [showQuickPatientModal, setShowQuickPatientModal] = useState(false);
  const [quickPatientForm, setQuickPatientForm] = useState<{
    ovog: string;
    name: string;
    phone: string;
    branchId: string;
    regNo: string;
  }>({
    ovog: "",
    name: "",
    phone: "",
    branchId: "",
    regNo: "",
  });
  const [quickPatientError, setQuickPatientError] = useState("");
  const [quickPatientSaving, setQuickPatientSaving] = useState(false);

  // ---- helpers ----
  const parseYmd = (ymd: string) => {
    const [y, m, d] = String(ymd || "").split("-").map(Number);
    if (!y || !m || !d) return null;
    return { y, m, d };
  };

  const parseIsoToLocalYmdHm = (iso: string) => {
    const dt = new Date(iso);
    if (Number.isNaN(dt.getTime())) return null;
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, "0");
    const d = String(dt.getDate()).padStart(2, "0");
    const hh = String(dt.getHours()).padStart(2, "0");
    const mm = String(dt.getMinutes()).padStart(2, "0");
    return { ymd: `${y}-${m}-${d}`, hm: `${hh}:${mm}` };
  };

  // initialize modal state on open
  useEffect(() => {
    if (!open) return;

    // EDIT MODE: preload from appointment
    if (editingAppointment) {
      const startParsed = parseIsoToLocalYmdHm(editingAppointment.scheduledAt);
      const endParsed = editingAppointment.endAt
        ? parseIsoToLocalYmdHm(editingAppointment.endAt)
        : null;

      const ymd = startParsed?.ymd || defaultDate;
      const startTime = startParsed?.hm || defaultTime;
      const endTime =
        endParsed?.hm || addMinutesToTimeString(startTime, SLOT_MINUTES);

      setForm((prev) => ({
        ...prev,
        // lock patient in UI (but we still store it)
        patientId: editingAppointment.patientId ?? null,
        patientQuery: editingAppointment.patient
          ? formatPatientSearchLabel(editingAppointment.patient as any)
          : prev.patientQuery,

        doctorId:
          editingAppointment.doctorId !== null && editingAppointment.doctorId !== undefined
            ? String(editingAppointment.doctorId)
            : "",

        branchId: String(editingAppointment.branchId),
        date: ymd,
        startTime,
        endTime,

        // status locked in edit mode (not used, but keep consistent)
        status: editingAppointment.status || "booked",
        notes: editingAppointment.notes || "",
      }));

      setError("");
      setPatientResults([]);
      return;
    }

    // CREATE MODE: reset to defaults
    setForm((prev) => ({
      ...prev,
      doctorId: defaultDoctorId ? String(defaultDoctorId) : "",
      branchId: selectedBranchId || prev.branchId,
      date: defaultDate,
      startTime: defaultTime,
      endTime: addMinutesToTimeString(defaultTime, SLOT_MINUTES),
      patientId: null,
      patientQuery: "",
      status: "booked",
      notes: "",
    }));
    setError("");
    setPatientResults([]);
  }, [open, defaultDoctorId, defaultDate, defaultTime, selectedBranchId, editingAppointment]);

  // slots calculation (same as your current, but in edit mode: filter by selected doctor schedule still ok)
  useEffect(() => {
    if (!form.date) {
      setPopupStartSlots([]);
      setPopupEndSlots([]);
      return;
    }

    const parsed = parseYmd(form.date);
    if (!parsed) {
      setPopupStartSlots([]);
      setPopupEndSlots([]);
      return;
    }

    const day = new Date(parsed.y, parsed.m - 1, parsed.d);

    let slots = generateTimeSlotsForDay(day).map((s) => ({
      label: s.label,
      start: s.start,
      end: s.end,
      value: getSlotTimeString(s.start),
    }));

    // Filter by doctor schedule if doctorId is selected
    if (form.doctorId) {
      const doctorIdNum = Number(form.doctorId);
      const doc = scheduledDoctors.find((sd) => sd.id === doctorIdNum);
      const schedules = doc?.schedules || [];

      if (schedules.length > 0) {
        slots = slots.filter((slot) => {
          const tStr = getSlotTimeString(slot.start);
          return schedules.some((s: any) =>
            isTimeWithinRange(tStr, s.startTime, s.endTime)
          );
        });
      }
    }

    const startOptions = slots.map(({ label, value }) => ({ label, value }));
    const endOptions = Array.from(
      new Set(slots.map((s) => getSlotTimeString(s.end)))
    ).map((t) => ({ label: t, value: t }));

    setPopupStartSlots(startOptions);
    setPopupEndSlots(endOptions);

    if (form.startTime && !startOptions.some((s) => s.value === form.startTime)) {
      setForm((prev) => ({ ...prev, startTime: "" }));
    }
    if (form.endTime && !endOptions.some((s) => s.value === form.endTime)) {
      setForm((prev) => ({ ...prev, endTime: "" }));
    }
  }, [form.date, form.doctorId, scheduledDoctors]);

  useEffect(() => {
    if (!form.branchId && branches.length > 0) {
      setForm((prev) => ({
        ...prev,
        branchId: String(branches[0].id),
      }));
    }
  }, [branches, form.branchId]);

  const triggerPatientSearch = (rawQuery: string) => {
    const query = rawQuery.trim();
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    if (!query) {
      setPatientResults([]);
      return;
    }

    const lower = query.toLowerCase();

    const t = setTimeout(async () => {
      try {
        setPatientSearchLoading(true);
        const url = `/api/patients?query=${encodeURIComponent(query)}`;
        const res = await fetch(url);
        const data = await res.json().catch(() => []);

        if (!res.ok) {
          setPatientResults([]);
          return;
        }

        const rawList = Array.isArray(data)
          ? data
          : Array.isArray((data as any).patients)
          ? (data as any).patients
          : [];

        const isNumeric = /^[0-9]+$/.test(lower);

        const filtered = rawList.filter((p: any) => {
          const regNo = (p.regNo ?? p.regno ?? "").toString().toLowerCase();
          const phone = (p.phone ?? "").toString().toLowerCase();
          const name = (p.name ?? "").toString().toLowerCase();
          const ovog = (p.ovog ?? "").toString().toLowerCase();
          const bookNumber = (p.patientBook?.bookNumber ?? "").toString().toLowerCase();

          if (isNumeric) {
            return regNo.includes(lower) || phone.includes(lower) || bookNumber.includes(lower);
          }

          return (
            regNo.includes(lower) ||
            phone.includes(lower) ||
            name.includes(lower) ||
            ovog.includes(lower) ||
            bookNumber.includes(lower)
          );
        });

        setPatientResults(
          filtered.map((p: any) => ({
            id: p.id,
            ovog: p.ovog ?? null,
            name: p.name,
            regNo: p.regNo ?? p.regno ?? "",
            phone: p.phone,
            patientBook: p.patientBook || null,
          }))
        );
      } catch (e) {
        console.error("patient search failed", e);
        setPatientResults([]);
      } finally {
        setPatientSearchLoading(false);
      }
    }, 300);

    setSearchDebounceTimer(t);
  };

  const handleSelectPatient = (p: PatientLite) => {
    setForm((prev) => ({
      ...prev,
      patientId: p.id,
      patientQuery: formatPatientSearchLabel(p),
    }));
    setPatientResults([]);
    setError("");
  };

  const handleChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>
  ) => {
    const { name, value } = e.target;

    if (name === "patientQuery") {
      // locked in edit mode
      if (isEditMode) return;

      setForm((prev) => ({ ...prev, patientQuery: value }));
      const trimmed = value.trim();
      if (!trimmed) {
        setForm((prev) => ({ ...prev, patientId: null }));
        setPatientResults([]);
        return;
      }
      triggerPatientSearch(value);
      return;
    }

    setForm((prev) => {
      if (name === "startTime") {
        const newStart = value;
        let newEnd = prev.endTime;
        if (!newEnd || newEnd <= newStart) {
          newEnd = addMinutesToTimeString(newStart, SLOT_MINUTES);
        }
        return { ...prev, startTime: newStart, endTime: newEnd };
      }

      if (name === "endTime") {
        return { ...prev, endTime: value };
      }

      // lock these fields in edit mode
      if (isEditMode && (name === "date" || name === "branchId" || name === "status")) {
        return prev;
      }

      return { ...prev, [name]: value };
    });
  };

  const handleQuickPatientChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>
  ) => {
    const { name, value } = e.target;
    setQuickPatientForm((prev) => ({ ...prev, [name]: value }));
  };

  const handleQuickPatientSave = async () => {
    // disabled in edit mode (UI won't show the button, but also guard here)
    if (isEditMode) return;

    setQuickPatientError("");

    if (!quickPatientForm.name.trim() || !quickPatientForm.phone.trim()) {
      setQuickPatientError("Нэр болон утас заавал бөглөнө үү.");
      return;
    }

    const branchIdFromModal = quickPatientForm.branchId
      ? Number(quickPatientForm.branchId)
      : null;
    const branchIdFromForm = form.branchId ? Number(form.branchId) : null;

    const branchIdForPatient = !Number.isNaN(branchIdFromModal ?? NaN)
      ? branchIdFromModal
      : branchIdFromForm;

    if (!branchIdForPatient || Number.isNaN(branchIdForPatient)) {
      setQuickPatientError("Шинэ үйлчлүүлэгч бүртгэхийн өмнө салбар сонгоно уу.");
      return;
    }

    setQuickPatientSaving(true);

    try {
      const payload: any = {
        name: quickPatientForm.name.trim(),
        phone: quickPatientForm.phone.trim(),
        branchId: branchIdForPatient,
        bookNumber: "",
      };

      if (quickPatientForm.ovog.trim()) payload.ovog = quickPatientForm.ovog.trim();
      if (quickPatientForm.regNo.trim()) payload.regNo = quickPatientForm.regNo.trim();

      const res = await fetch("/api/patients", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => null);

      if (!res.ok || !data || typeof data.id !== "number") {
        setQuickPatientError((data && (data as any).error) || "Шинэ үйлчлүүлэгч бүртгэх үед алдаа гарлаа.");
        setQuickPatientSaving(false);
        return;
      }

      const p: PatientLite = {
        id: data.id,
        name: data.name,
        ovog: data.ovog ?? null,
        regNo: data.regNo ?? "",
        phone: data.phone ?? null,
        patientBook: data.patientBook || null,
      };

      setForm((prev) => ({
        ...prev,
        patientId: p.id,
        patientQuery: formatPatientSearchLabel(p),
      }));

      setQuickPatientForm({ ovog: "", name: "", phone: "", branchId: "", regNo: "" });
      setShowQuickPatientModal(false);
    } catch (e) {
      console.error(e);
      setQuickPatientError("Сүлжээгээ шалгана уу.");
    } finally {
      setQuickPatientSaving(false);
    }
  };

  const handleOpenPatientProfileNewTab = () => {
    // Open patient profile in new tab using the same URL pattern you already use
    // Requires patientBook.bookNumber or patientId route depending on your app.
    // Here we try to use patientBook.bookNumber if present.
    const p =
      (editingAppointment && (editingAppointment.patient as any)) ||
      null;

    const bookNumber = p?.patientBook?.bookNumber;

    if (bookNumber) {
      const url = `/patients/profile/${encodeURIComponent(String(bookNumber))}`;
      window.open(url, "_blank", "noopener,noreferrer");
      return;
    }

    // fallback: if you have a patient page by id, adjust as needed
    if (form.patientId) {
      const url = `/patients/${form.patientId}`;
      window.open(url, "_blank", "noopener,noreferrer");
      return;
    }

    setError("Үйлчлүүлэгчийн картын дугаар олдсонгүй.");
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");

    // --- validations ---
    if (!form.date || !form.startTime || !form.endTime) {
      setError("Огноо, эхлэх/дуусах цаг талбаруудыг бөглөнө үү.");
      return;
    }

    if (!isEditMode) {
      if (!form.branchId) {
        setError("Салбар сонгоно уу.");
        return;
      }
      if (!form.patientId) {
        setError("Үйлчлүүлэгчийг жагсаалтаас сонгоно уу.");
        return;
      }
      if (!form.doctorId) {
        setError("Цаг захиалахын өмнө эмчийг заавал сонгоно уу.");
        return;
      }
    } else {
      // edit mode: branch/date/patient fixed; doctor can be blank? you said allow doctor change => must exist.
      if (!form.doctorId) {
        setError("Эмч сонгоно уу.");
        return;
      }
    }

    const parsed = parseYmd(form.date);
    if (!parsed) {
      setError("Огноо буруу байна.");
      return;
    }
    const [startHour, startMinute] = form.startTime.split(":").map(Number);
    const [endHour, endMinute] = form.endTime.split(":").map(Number);

    const start = new Date(parsed.y, parsed.m - 1, parsed.d, startHour || 0, startMinute || 0, 0, 0);
    const end = new Date(parsed.y, parsed.m - 1, parsed.d, endHour || 0, endMinute || 0, 0, 0);

    if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
      setError("Огноо/цаг буруу байна.");
      return;
    }
    if (end <= start) {
      setError("Дуусах цаг нь эхлэх цагаас хойш байх ёстой.");
      return;
    }

    const scheduledAtStr = start.toISOString();
    const endAtStr = end.toISOString();

    try {
      if (!isEditMode) {
        // CREATE
        const res = await fetch("/api/appointments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            patientId: form.patientId,
            doctorId: Number(form.doctorId),
            branchId: Number(form.branchId),
            scheduledAt: scheduledAtStr,
            endAt: endAtStr,
            status: form.status,
            notes: form.notes || null,
          }),
        });

        let data: Appointment | { error?: string };
        try {
          data = await res.json();
        } catch {
          data = { error: "Unknown error" };
        }

        if (!res.ok) {
          setError((data as any).error || "Алдаа гарлаа");
          return;
        }

        onCreated(data as Appointment);
        onClose();
        return;
      }

      // EDIT
      if (!editingAppointment) {
        setError("Засварлах цаг олдсонгүй.");
        return;
      }

      const res = await fetch(`/api/appointments/${editingAppointment.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          scheduledAt: scheduledAtStr,
          endAt: endAtStr,
          doctorId: Number(form.doctorId),
          notes: form.notes || null,
          // IMPORTANT: do not send patientId/branchId/status in edit mode
        }),
      });

      let data: Appointment | { error?: string };
      try {
        data = await res.json();
      } catch {
        data = { error: "Unknown error" };
      }

      if (!res.ok) {
        setError((data as any).error || "Алдаа гарлаа");
        return;
      }

      onUpdated?.(data as Appointment);
      onClose();
    } catch {
      setError("Сүлжээгээ шалгана уу");
    }
  };

  if (!open) return null;

  return (
    <div
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,0.35)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: 70,
      }}
      onClick={onClose}
    >
      <div
        onClick={(e) => e.stopPropagation()}
        style={{
          width: 520,
          maxWidth: "95vw",
          maxHeight: "90vh",
          overflowY: "auto",
          background: "#ffffff",
          borderRadius: 8,
          boxShadow: "0 14px 40px rgba(0,0,0,0.25)",
          padding: 16,
          fontSize: 13,
        }}
      >
        <div
          style={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            marginBottom: 8,
          }}
        >
          <h3 style={{ margin: 0, fontSize: 15 }}>
            {isEditMode ? "Цаг засварлах" : "Шинэ цаг захиалах"}
          </h3>
          <button
            type="button"
            onClick={onClose}
            style={{
              border: "none",
              background: "transparent",
              cursor: "pointer",
              fontSize: 18,
              lineHeight: 1,
            }}
            aria-label="Close"
          >
            ×
          </button>
        </div>

        <form
          onSubmit={handleSubmit}
          style={{
            display: "grid",
            gap: 10,
            gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
          }}
        >
          {/* Patient (locked in edit mode) */}
          <div
            style={{
              gridColumn: "1 / -1",
              display: "flex",
              flexDirection: "column",
              gap: 4,
            }}
          >
            <label>Үйлчлүүлэгч</label>
            <div style={{ display: "flex", gap: 6 }}>
              <input
                name="patientQuery"
                placeholder="РД, овог, нэр утсаар хайх"
                value={form.patientQuery}
                onChange={handleChange}
                autoComplete="off"
                disabled={isEditMode}
                style={{
                  flex: 1,
                  borderRadius: 6,
                  border: "1px solid #d1d5db",
                  padding: "6px 8px",
                  background: isEditMode ? "#f9fafb" : "white",
                }}
              />

              {!isEditMode ? (
                <button
                  type="button"
                  onClick={() => {
                    setShowQuickPatientModal(true);
                    setQuickPatientError("");
                    setQuickPatientForm((prev) => ({
                      ...prev,
                      branchId: prev.branchId || form.branchId,
                    }));
                  }}
                  style={{
                    padding: "0 10px",
                    borderRadius: 6,
                    border: "1px solid #16a34a",
                    background: "#dcfce7",
                    color: "#166534",
                    fontWeight: 600,
                    cursor: "pointer",
                  }}
                  title="Шинэ үйлчлүүлэгчийн бүртгэл"
                >
                  +
                </button>
              ) : (
                <button
                  type="button"
                  onClick={handleOpenPatientProfileNewTab}
                  style={{
                    padding: "0 10px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: "#f9fafb",
                    cursor: "pointer",
                    fontWeight: 600,
                  }}
                  title="Дэлгэрэнгүй (шинэ таб)"
                >
                  Дэлгэрэнгүй
                </button>
              )}
            </div>

            {patientSearchLoading && !isEditMode && (
              <span style={{ fontSize: 11, color: "#6b7280", marginTop: 2 }}>
                Үйлчлүүлэгч хайж байна...
              </span>
            )}
          </div>

          {!isEditMode && patientResults.length > 0 && (
            <div
              style={{
                gridColumn: "1 / -1",
                borderRadius: 6,
                border: "1px solid #e5e7eb",
                background: "#ffffff",
                maxHeight: 200,
                overflowY: "auto",
              }}
            >
              {patientResults.map((p) => (
                <button
                  key={p.id}
                  type="button"
                  onClick={() => handleSelectPatient(p)}
                  style={{
                    display: "block",
                    width: "100%",
                    textAlign: "left",
                    padding: "6px 8px",
                    border: "none",
                    borderBottom: "1px solid #f3f4f6",
                    background: "white",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  {formatPatientSearchLabel(p)}
                </button>
              ))}
            </div>
          )}

          {/* Date (locked in edit mode) */}
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            <label>Огноо</label>
            <input
              type="date"
              name="date"
              value={form.date}
              onChange={handleChange}
              required
              disabled={isEditMode}
              style={{
                borderRadius: 6,
                border: "1px solid #d1d5db",
                padding: "6px 8px",
                background: isEditMode ? "#f9fafb" : "white",
              }}
            />
          </div>

          {/* Doctor (editable in edit mode) */}
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            <label>Эмч</label>
            <select
              name="doctorId"
              value={form.doctorId}
              onChange={handleChange}
              required
              style={{
                borderRadius: 6,
                border: "1px solid #d1d5db",
                padding: "6px 8px",
              }}
            >
              <option value="">Сонгох</option>
              {workingDoctors.map((d: any) => (
                <option key={d.id} value={d.id}>
                  {formatDoctorName(d)}
                </option>
              ))}
            </select>
          </div>

          {/* Start time (editable) */}
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            <label>Эхлэх цаг</label>
            <select
              name="startTime"
              value={form.startTime}
              onChange={handleChange}
              required
              style={{
                borderRadius: 6,
                border: "1px solid #d1d5db",
                padding: "6px 8px",
              }}
            >
              <option value="">Эхлэх цаг</option>
              {popupStartSlots.map((slot) => (
                <option key={slot.value} value={slot.value}>
                  {slot.label}
                </option>
              ))}
            </select>
          </div>

          {/* End time (editable) */}
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            <label>Дуусах цаг</label>
            <select
              name="endTime"
              value={form.endTime}
              onChange={handleChange}
              required
              style={{
                borderRadius: 6,
                border: "1px solid #d1d5db",
                padding: "6px 8px",
              }}
            >
              <option value="">Дуусах цаг</option>
              {popupEndSlots.map((slot) => (
                <option key={slot.value} value={slot.value}>
                  {slot.label}
                </option>
              ))}
            </select>
          </div>

          {/* Status (create only) */}
          {!isEditMode && (
            <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
              <label>Төлөв</label>
              <select
                name="status"
                value={form.status}
                onChange={handleChange}
                style={{
                  borderRadius: 6,
                  border: "1px solid #d1d5db",
                  padding: "6px 8px",
                }}
              >
                <option value="booked">Захиалсан</option>
                <option value="confirmed">Баталгаажсан</option>
                <option value="online">Онлайн</option>
                <option value="ongoing">Явагдаж байна</option>
                <option value="imaging">Зураг авах</option>
                <option value="ready_to_pay">Төлбөр төлөх</option>
                <option value="completed">Дууссан</option>
                <option value="no_show">Ирээгүй</option>
                <option value="cancelled">Цуцалсан</option>
                <option value="other">Бусад</option>
              </select>
            </div>
          )}

          {/* Notes (editable) */}
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              gap: 4,
              gridColumn: "1 / -1",
            }}
          >
            <label>Тэмдэглэл</label>
            <input
              name="notes"
              value={form.notes}
              onChange={handleChange}
              placeholder="Захиалгын товч тэмдэглэл"
              style={{
                borderRadius: 6,
                border: "1px solid #d1d5db",
                padding: "6px 8px",
              }}
            />
          </div>

          <div
            style={{
              gridColumn: "1 / -1",
              display: "flex",
              justifyContent: "flex-end",
              gap: 8,
              marginTop: 4,
            }}
          >
            {error && (
              <div
                style={{
                  color: "#b91c1c",
                  fontSize: 12,
                  alignSelf: "center",
                  marginRight: "auto",
                }}
              >
                {error}
              </div>
            )}

            <button
              type="button"
              onClick={onClose}
              style={{
                padding: "6px 12px",
                borderRadius: 6,
                border: "1px solid #d1d5db",
                background: "#f9fafb",
                cursor: "pointer",
              }}
            >
              Цуцлах
            </button>

            <button
              type="submit"
              style={{
                padding: "6px 12px",
                borderRadius: 6,
                border: "none",
                background: "#2563eb",
                color: "white",
                cursor: "pointer",
              }}
            >
              Хадгалах
            </button>
          </div>

          {/* Quick new patient modal (create only) */}
          {!isEditMode && showQuickPatientModal && (
            <div
              style={{
                position: "fixed",
                inset: 0,
                background: "rgba(0,0,0,0.3)",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                zIndex: 60,
              }}
            >
              <div
                style={{
                  background: "white",
                  borderRadius: 8,
                  padding: 16,
                  width: 340,
                  boxShadow: "0 10px 25px rgba(0,0,0,0.15)",
                  fontSize: 13,
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <h3 style={{ marginTop: 0, marginBottom: 8, fontSize: 15 }}>
                  Шинэ үйлчлүүлэгчийн бүртгэл
                </h3>

                <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                  <label style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    Овог
                    <input
                      name="ovog"
                      value={quickPatientForm.ovog}
                      onChange={handleQuickPatientChange}
                      style={{ borderRadius: 6, border: "1px solid #d1d5db", padding: "6px 8px" }}
                    />
                  </label>

                  <label style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    Нэр
                    <input
                      name="name"
                      value={quickPatientForm.name}
                      onChange={handleQuickPatientChange}
                      style={{ borderRadius: 6, border: "1px solid #d1d5db", padding: "6px 8px" }}
                    />
                  </label>

                  <label style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    Утас
                    <input
                      name="phone"
                      value={quickPatientForm.phone}
                      onChange={handleQuickPatientChange}
                      style={{ borderRadius: 6, border: "1px solid #d1d5db", padding: "6px 8px" }}
                    />
                  </label>

                  <label style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    Салбар
                    <select
                      name="branchId"
                      value={quickPatientForm.branchId}
                      onChange={handleQuickPatientChange}
                      style={{ borderRadius: 6, border: "1px solid #d1d5db", padding: "6px 8px" }}
                    >
                      <option value="">Сонгох</option>
                      {branches.map((b) => (
                        <option key={b.id} value={b.id}>
                          {b.name}
                        </option>
                      ))}
                    </select>
                  </label>

                  <label style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                    РД
                    <input
                      name="regNo"
                      value={quickPatientForm.regNo}
                      onChange={handleQuickPatientChange}
                      style={{ borderRadius: 6, border: "1px solid #d1d5db", padding: "6px 8px" }}
                    />
                  </label>

                  {quickPatientError && (
                    <div style={{ color: "#b91c1c", fontSize: 12 }}>
                      {quickPatientError}
                    </div>
                  )}

                  <div style={{ display: "flex", justifyContent: "flex-end", gap: 8, marginTop: 8 }}>
                    <button
                      type="button"
                      onClick={() => {
                        if (!quickPatientSaving) {
                          setShowQuickPatientModal(false);
                          setQuickPatientError("");
                        }
                      }}
                      style={{
                        padding: "6px 12px",
                        borderRadius: 6,
                        border: "1px solid #d1d5db",
                        background: "#f9fafb",
                        cursor: quickPatientSaving ? "default" : "pointer",
                      }}
                    >
                      Цуцлах
                    </button>

                    <button
                      type="button"
                      onClick={handleQuickPatientSave}
                      disabled={quickPatientSaving}
                      style={{
                        padding: "6px 12px",
                        borderRadius: 6,
                        border: "none",
                        background: "#16a34a",
                        color: "white",
                        cursor: quickPatientSaving ? "default" : "pointer",
                      }}
                    >
                      {quickPatientSaving ? "Хадгалж байна..." : "Хадгалах"}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </form>
      </div>
    </div>
  );
}
