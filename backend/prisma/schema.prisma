// DATASOURCE
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// GENERATOR
generator client {
  provider = "prisma-client-js"
}

// ENUMS
enum UserRole {
  admin
  doctor
  receptionist
  accountant
  nurse
  manager
}

enum ServiceCategory {
  GENERAL_DENTISTRY
  IMPLANTS
  ORTHODONTICS
  COSMETIC_DENTISTRY
  CHILDRENS
}

// BRANCHES
model Branch {
  id        Int              @id @default(autoincrement())
  name      String
  address   String?
  createdAt DateTime         @default(now())
  users     User[]
  patients  Patient[]        // direct branch-to-patient relation

  // NEW: back‑relation to DoctorSchedule
  schedules DoctorSchedule[]
}

// USERS (Doctors, Nurses, Admin, etc.)
model User {
  id                 Int              @id @default(autoincrement())
  email              String           @unique
  password           String
  ovog      String?      // NEW: father’s name for all users
  name               String?
  role               UserRole         @default(receptionist)
  branchId           Int?
  createdAt          DateTime         @default(now())
  branch             Branch?          @relation(fields: [branchId], references: [id])
  encounters         Encounter[]      @relation("DoctorEncounters")

  // Advanced Doctor/Nurse Info
  regNo              String?          @unique
  licenseNumber      String?          @unique
  licenseExpiryDate  DateTime?
  signatureImagePath String?
  stampImagePath     String?
  idPhotoPath        String?

  // NEW: back‑relation to DoctorSchedule
  schedules          DoctorSchedule[]
}

// PATIENTS (single, original model; back relation added)
model Patient {
  id             Int          @id @default(autoincrement())
  regNo          String       @unique
  ovog           String?
  name           String
  gender         String?
  birthDate      DateTime?
  phone          String?
  address        String?
  bloodType      String?
  citizenship    String?      @default("Mongolian")
  emergencyPhone String?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  branchId       Int
  branch         Branch       @relation(fields: [branchId], references: [id])

  patientBook    PatientBook?

  // Back-relation to appointments
  appointments   Appointment[]
}

// Appointment model (define once)
model Appointment {
  id          Int       @id @default(autoincrement())
  patientId   Int
  doctorId    Int?
  branchId    Int
  scheduledAt DateTime
  status      String    @default("booked")
  notes       String?

  patient     Patient   @relation(fields: [patientId], references: [id])

  @@index([branchId, scheduledAt])
}

// DIGITAL HISTORY BOOK
model PatientBook {
  id         Int         @id @default(autoincrement())
  bookNumber String      @unique
  patientId  Int         @unique
  patient    Patient     @relation(fields: [patientId], references: [id])
  encounters Encounter[]
}

model Encounter {
  id                 Int           @id @default(autoincrement())
  patientBookId      Int
  doctorId           Int
  visitDate          DateTime
  notes              String?

  patientBook        PatientBook   @relation(fields: [patientBookId], references: [id])
  doctor             User          @relation("DoctorEncounters", fields: [doctorId], references: [id])
  chartTeeth         ChartTooth[]
  invoice            Invoice?
  media              Media[]
  encounterServices  EncounterService[]
}

// CHARTING
model ChartTooth {
  id          Int        @id @default(autoincrement())
  toothCode   String
  status      String?
  notes       String?
  encounterId Int
  encounter   Encounter  @relation(fields: [encounterId], references: [id])
  chartNotes  ChartNote[]
}

model ChartNote {
  id           Int        @id @default(autoincrement())
  chartToothId Int
  description  String
  createdAt    DateTime   @default(now())
  chartTooth   ChartTooth @relation(fields: [chartToothId], references: [id])
}

// SERVICES, PROCEDURES, DIAGNOSES
model Service {
  id                Int              @id @default(autoincrement())
  code              String           @unique
  category          ServiceCategory
  name              String
  price             Float
  status            Boolean          @default(true)
  description       String?
  encounterServices EncounterService[]
}

model EncounterService {
  id           Int       @id @default(autoincrement())
  encounter    Encounter @relation(fields: [encounterId], references: [id])
  encounterId  Int
  service      Service   @relation(fields: [serviceId], references: [id])
  serviceId    Int
  quantity     Int       @default(1)
  price        Float
}

model Procedure {
  code         String       @id
  name         String
  price        Float
  invoiceItems InvoiceItem[]
}

model Diagnosis {
  code        String @id
  description String
}

// INVOICES & PAYMENTS
model Invoice {
  id             Int           @id @default(autoincrement())
  encounterId    Int           @unique
  totalAmount    Float
  status         String
  createdAt      DateTime      @default(now())
  encounter      Encounter     @relation(fields: [encounterId], references: [id])
  invoiceItems   InvoiceItem[]
  payment        Payment?
  eBarimtReceipt EBarimtReceipt?
}

model InvoiceItem {
  id          Int       @id @default(autoincrement())
  invoiceId   Int
  procedureId String
  price       Float
  quantity    Int
  invoice     Invoice   @relation(fields: [invoiceId], references: [id])
  procedure   Procedure @relation(fields: [procedureId], references: [code])
}

model Payment {
  id        Int      @id @default(autoincrement())
  invoiceId Int      @unique
  amount    Float
  method    String
  qpayTxnId String?
  timestamp DateTime @default(now())
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
}

model EBarimtReceipt {
  id            Int      @id @default(autoincrement())
  invoiceId     Int      @unique
  receiptNumber String   @unique
  timestamp     DateTime @default(now())
  invoice       Invoice  @relation(fields: [invoiceId], references: [id])
}

// MEDIA (photos, files, etc.)
model Media {
  id          Int      @id @default(autoincrement())
  encounterId Int
  filePath    String
  toothCode   String?
  type        String
  encounter   Encounter @relation(fields: [encounterId], references: [id])
}
model DoctorSchedule {
  id        Int      @id @default(autoincrement())
  doctorId  Int
  branchId  Int
  weekday   Int      // 1=Mon ... 7=Sun
  startTime String   // "09:00"
  endTime   String   // "17:00"
  doctor    User     @relation(fields: [doctorId], references: [id])
  branch    Branch   @relation(fields: [branchId], references: [id])
}
